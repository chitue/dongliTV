name: ğŸ“¦ Auto Publish Release

on:
  push:
    tags:
      - 'v*.*.*'                # åªå¯¹vå¼€å¤´çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾è§¦å‘ï¼Œä¾‹å¦‚ v1.2.3

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # å¿…éœ€æƒé™ï¼šå†™å…¥ä»“åº“å†…å®¹ä»¥åˆ›å»ºRelease

    steps:
      # 1. è·å–ä»£ç 
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # è·å–å…¨éƒ¨å†å²ï¼Œç¡®ä¿æ ‡ç­¾ä¿¡æ¯å®Œæ•´

      # 2. åˆ›å»ºè¿‡æ»¤åçš„å‘å¸ƒåŒ…ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
      - name: ğŸ“¦ Create filtered release package
        run: |
          # æå–æ ‡ç­¾åï¼ˆå¦‚ v1.2.3ï¼‰
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          # å®šä¹‰è¾“å‡ºæ–‡ä»¶å
          RELEASE_ZIP="dongliTV-${TAG_NAME}.zip"
          # å…³é”®å‘½ä»¤ï¼šä½¿ç”¨git archiveæ‰“åŒ…ï¼Œå®ƒä¼šè‡ªåŠ¨åº”ç”¨.gitattributesä¸­çš„export-ignoreè§„åˆ™
          git archive --format=zip --output="${RELEASE_ZIP}" HEAD
          # å°†æ–‡ä»¶åè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "RELEASE_ZIP=${RELEASE_ZIP}" >> $GITHUB_ENV
          # ç®€å•åˆ—å‡ºåŒ…å†…å†…å®¹ä»¥ä¾¿åœ¨æ—¥å¿—ä¸­éªŒè¯
          echo "Package contents (top 10):"
          unzip -l "${RELEASE_ZIP}" | head -12

      # 3. åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ èµ„äº§
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # åŸºæœ¬è®¾ç½®
          generate_release_notes: true    # è‡ªåŠ¨ä»æäº¤è®°å½•ç”Ÿæˆæ›´æ–°è¯´æ˜
          draft: false                     # ç›´æ¥å‘å¸ƒï¼Œéè‰ç¨¿
          prerelease: false                # æ­£å¼ç‰ˆï¼Œéé¢„å‘å¸ƒ
          # èµ„äº§æ–‡ä»¶è®¾ç½®
          files: |
            ${{ env.RELEASE_ZIP }}        # ä¸Šä¼ æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„è‡ªå®šä¹‰ZIPåŒ…
          # å¯é€‰çš„é™„åŠ è®¾ç½®
          # fail_on_unmatched_files: false # å¦‚æœæ–‡ä»¶æœªæ‰¾åˆ°ä¸ä½¿æ„å»ºå¤±è´¥ï¼ˆæŒ‰éœ€å¼€å¯ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHubè‡ªåŠ¨æä¾›çš„å‡­è¯